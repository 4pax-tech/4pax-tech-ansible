---
- name: restart ssh (docker)
  listen: "restart ssh"
  when: is_docker | default(false)
  become: true
  shell: |
    set -e

    # Ensure sshd binary exists
    if ! command -v {{ sshd_binary | default('sshd') }} >/dev/null 2>&1; then
      echo "sshd binary not found" >&2
      exit 2
    fi

    # Validate config
    {{ sshd_binary | default('sshd') }} -t -f {{ ssh_config_path | default('/etc/ssh/sshd_config') }}

    # Find sshd PID
    pid=$(pgrep -x sshd || pidof sshd || true)

    if [ -z "$pid" ]; then
      echo "sshd PID not found" >&2

      if [ -x /etc/init.d/ssh ]; then
        nohup /etc/init.d/ssh restart >/dev/null 2>&1 || exit 3
      else
        exit 4
      fi
    else
      kill -HUP "$pid"
    fi

- name: restart ssh (normal host)
  listen: "restart ssh"
  when: not (is_docker | default(false))
  become: true
  service:
    name: ssh
    state: restarted

- name: restart fail2ban (docker)
  listen: "restart fail2ban"
  when: is_docker | default(false)
  become: true
  shell: |
    set -e
    if pgrep -f fail2ban-server >/dev/null 2>&1; then
      echo "Stopping fail2ban"
      fail2ban-client stop || true
      sleep 1
    fi
    nohup fail2ban-server -xf start >/dev/null 2>&1 &
  args:
    executable: /bin/sh

- name: restart fail2ban (normal host)
  listen: "restart fail2ban"
  when: not (is_docker | default(false))
  become: true
  service:
    name: fail2ban
    state: restarted

- name: save iptables (docker)
  listen: "save iptables"
  when: is_docker | default(false)
  shell: |
    mkdir -p /etc/iptables
    iptables-save > /etc/iptables/rules-save
    ip6tables-save > /etc/iptables/rules6-save
  args:
    executable: /bin/sh

- name: save iptables (normal host)
  listen: "save iptables"
  when: not(is_docker | default(false))
  command: /etc/init.d/iptables save