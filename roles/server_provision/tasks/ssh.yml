---
- name: Check for sshd binary
  stat:
    path: /usr/sbin/sshd
  register: sshd_bin

- name: Check for sshd.pam binary (Alpine/LinuxServer)
  stat:
    path: /usr/sbin/sshd.pam
  register: sshd_pam_bin

- name: Set sshd binary path
  set_fact:
    sshd_binary: "{{ '/usr/sbin/sshd.pam' if sshd_pam_bin.stat.exists else '/usr/sbin/sshd' }}"

- name: Deploy SSH config
  template:
    src: sshd_config.j2
    dest: "{{ ssh_config_path | default('/etc/ssh/sshd_config') }}"
    backup: yes
    validate: "{{ sshd_binary }} -t -f %s"
  notify: restart ssh

- name: Check SSH port is active
  command: "ss -tulpn | grep -E ':{{ ssh_port }} '"
  register: ssh_port_check
  failed_when: false

- name: Reboot if SSH port did not activate
  reboot:
  when:
    - allow_reboot_if_ssh_changed
    - ssh_port_check.rc != 0
