---
# Alpine-specific tasks
- name: Set SSH service name for Alpine
  set_fact:
    ssh_service: "{{ ssh_service_alpine }}"

- name: Check for s6-overlay sshd service
  stat:
    path: /run/service/svc-openssh-server
  register: s6_sshd_svc

- name: Set SSH service restart command for s6
  set_fact:
    ssh_restart_handler_type: "s6"
    ssh_s6_service_path: "/run/service/svc-openssh-server"
    ssh_config_path: "/config/sshd/sshd_config"
  when: s6_sshd_svc.stat.exists


- name: Ensure sudo is installed (Alpine)
  apk:
    name: sudo
    state: present

- name: Ensure openssh is installed (Alpine)
  apk:
    name:
      - openssh
      - openssh-sftp-server
    state: present
    update_cache: yes
  when: ansible_facts["virtualization_type"] not in ["docker", "container"]

- name: Ensure sshd service is enabled at boot (Alpine)
  command: rc-update add sshd default
  args:
    creates: /etc/runlevels/default/sshd
  become: yes
  changed_when: false
  failed_when: false

# Ensure /etc/ssh exists and has reasonable permissions (helpful before templating)
- name: Ensure /etc/ssh exists (Alpine)
  file:
    path: /etc/ssh
    state: directory
    owner: root
    group: root
    mode: "0755"

# Optional: ensure iptables is present for firewall tasks
- name: Ensure iptables package is installed (Alpine)
  apk:
    name: iptables
    state: present
    update_cache: yes
  when: "'iptables' in (firewall_backend | default('iptables')) or ansible_facts['pkg_mgr'] == 'apk'"

# If we changed anything that requires handlers, handlers will run from other tasks via notify
